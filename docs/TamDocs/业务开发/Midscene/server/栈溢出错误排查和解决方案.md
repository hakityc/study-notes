# Windows Agent 栈溢出错误排查和解决方案

## 🔍 错误现象分析

### 错误信息

```
🚀 开始执行 Windows AI 任务: 分析一下当前页面内容，告知我
file:///Users/lebo/lebo/project/midscene-server/apps/server/src/services/customMidsceneDevice/agentOverWindows.ts:1
var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:true});...

RangeError: Maximum call stack size exceeded
```

### 关键发现

**错误信息中显示的是打包后的代码 (`var __defProp=Object.defineProperty...`)，而不是源代码**

这表明：

1. ✅ 源代码可能已经修复
2. ❌ 但运行的是 `dist/` 目录下的**旧代码**
3. ❌ 修改后没有重新构建项目

## ✅ 解决步骤

### 步骤 1: 清理旧的构建文件

```bash
# 进入 server 目录
cd /Users/lebo/lebo/project/midscene-server/apps/server

# 清理 dist 目录
rm -rf dist

# 如果有 node_modules，也可以考虑重新安装（可选）
# rm -rf node_modules
# pnpm install
```

### 步骤 2: 重新构建项目

```bash
# 在 server 目录下构建
pnpm run build

# 或者在项目根目录构建所有包
cd /Users/lebo/lebo/project/midscene-server
pnpm run build
```

### 步骤 3: 重启服务

```bash
# 停止当前运行的服务（Ctrl+C）
# 然后重新启动
pnpm run dev
# 或
pnpm run start
```

## 🔧 验证代码是否正确修复

### 1. 检查 `windowsOperateService.ts`

确认 `defaultAgentConfig` **不包含** `onTaskStartTip`:

```typescript
private readonly defaultAgentConfig: Omit<
  AgentOverWindowsOpt,
  'onTaskStartTip'
> = {
  closeAfterDisconnect: false,
  generateReport: true,
  autoPrintReportMsg: true,
  deviceOptions: {
    deviceName: 'Windows Desktop',
    debug: true,
  },
};
```

确认在 `createAgent()` 中**动态创建回调**:

```typescript
this.agent = new AgentOverWindows({
  ...this.defaultAgentConfig,
  onTaskStartTip: (tip: string) => {
    this.handleTaskStartTip(tip);
  },
});
```

### 2. 检查 `agentOverWindows.ts`

**当前实现** (直接传递 opts):

```typescript
constructor(opts?: AgentOverWindowsOpt) {
  const windowsDevice = new WindowsDevice(opts?.deviceOptions);
  super(windowsDevice, opts);
  this.destroyAfterDisconnectFlag = opts?.closeAfterDisconnect;
}
```

这个实现**应该是正确的**，因为：

1. `windowsOperateService` 在 `createAgent()` 中动态创建回调
2. 回调函数中的 `this` 正确绑定到 `WindowsOperateService` 实例
3. 直接传递 opts 避免了多层嵌套

## 🎯 根本原因总结

根据已有的修复文档 (`CALLBACK_STACK_OVERFLOW_ROOT_CAUSE.md`)，问题的根本原因是：

1. **类属性中使用箭头函数引用 `this`** - 已修复 ✅
   - 从 `defaultAgentConfig` 中移除了 `onTaskStartTip`
   - 在 `createAgent()` 方法中动态创建回调

2. **运行旧的构建文件** - 需要重新构建 ⚠️
   - 源代码已修复，但 `dist/` 目录包含旧代码
   - 需要清理并重新构建

## 📋 检查清单

执行以下操作后，问题应该解决：

- [ ] 清理 `dist` 目录
- [ ] 重新构建项目
- [ ] 重启服务
- [ ] 测试执行 Windows AI 任务
- [ ] 确认不再出现栈溢出错误

## 🚨 如果问题仍然存在

如果重新构建后问题仍然存在，请提供以下信息：

1. **确认是否在开发模式下运行**
   - 使用 `pnpm run dev` (监听源代码变化)
   - 还是 `pnpm run start` (运行构建后的代码)

2. **检查是否有多个 Node 进程**

   ```bash
   ps aux | grep node
   # 确保没有旧的服务进程仍在运行
   ```

3. **提供完整的错误堆栈**
   - 使用 `node --trace-uncaught` 启动服务
   - 获取完整的调用栈信息

4. **检查 package.json 中的启动命令**

   ```bash
   cat package.json | grep -A 5 "scripts"
   ```

## 🔗 相关文档

- `CALLBACK_STACK_OVERFLOW_ROOT_CAUSE.md` - 根本原因分析
- `CALLBACK_TIMING_ISSUE_FIX.md` - 回调时机问题修复
- `CALLBACK_RECURSION_FIX.md` - 回调递归问题修复

---

**修复日期**: 2025-10-13  
**问题类型**: 构建缓存问题 + 类属性箭头函数上下文问题  
**修复方案**: 清理构建 + 动态创建回调
