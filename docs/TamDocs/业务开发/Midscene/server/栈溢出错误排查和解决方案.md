# Windows Agent æ ˆæº¢å‡ºé”™è¯¯æ’æŸ¥å’Œè§£å†³æ–¹æ¡ˆ

## ğŸ” é”™è¯¯ç°è±¡åˆ†æ

### é”™è¯¯ä¿¡æ¯

```
ğŸš€ å¼€å§‹æ‰§è¡Œ Windows AI ä»»åŠ¡: åˆ†æä¸€ä¸‹å½“å‰é¡µé¢å†…å®¹ï¼Œå‘ŠçŸ¥æˆ‘
file:///Users/lebo/lebo/project/midscene-server/apps/server/src/services/customMidsceneDevice/agentOverWindows.ts:1
var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:true});...

RangeError: Maximum call stack size exceeded
```

### å…³é”®å‘ç°

**é”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤ºçš„æ˜¯æ‰“åŒ…åçš„ä»£ç  (`var __defProp=Object.defineProperty...`)ï¼Œè€Œä¸æ˜¯æºä»£ç **

è¿™è¡¨æ˜ï¼š

1. âœ… æºä»£ç å¯èƒ½å·²ç»ä¿®å¤
2. âŒ ä½†è¿è¡Œçš„æ˜¯ `dist/` ç›®å½•ä¸‹çš„**æ—§ä»£ç **
3. âŒ ä¿®æ”¹åæ²¡æœ‰é‡æ–°æ„å»ºé¡¹ç›®

## âœ… è§£å†³æ­¥éª¤

### æ­¥éª¤ 1: æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶

```bash
# è¿›å…¥ server ç›®å½•
cd /Users/lebo/lebo/project/midscene-server/apps/server

# æ¸…ç† dist ç›®å½•
rm -rf dist

# å¦‚æœæœ‰ node_modulesï¼Œä¹Ÿå¯ä»¥è€ƒè™‘é‡æ–°å®‰è£…ï¼ˆå¯é€‰ï¼‰
# rm -rf node_modules
# pnpm install
```

### æ­¥éª¤ 2: é‡æ–°æ„å»ºé¡¹ç›®

```bash
# åœ¨ server ç›®å½•ä¸‹æ„å»º
pnpm run build

# æˆ–è€…åœ¨é¡¹ç›®æ ¹ç›®å½•æ„å»ºæ‰€æœ‰åŒ…
cd /Users/lebo/lebo/project/midscene-server
pnpm run build
```

### æ­¥éª¤ 3: é‡å¯æœåŠ¡

```bash
# åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡ï¼ˆCtrl+Cï¼‰
# ç„¶åé‡æ–°å¯åŠ¨
pnpm run dev
# æˆ–
pnpm run start
```

## ğŸ”§ éªŒè¯ä»£ç æ˜¯å¦æ­£ç¡®ä¿®å¤

### 1. æ£€æŸ¥ `windowsOperateService.ts`

ç¡®è®¤ `defaultAgentConfig` **ä¸åŒ…å«** `onTaskStartTip`:

```typescript
private readonly defaultAgentConfig: Omit<
  AgentOverWindowsOpt,
  'onTaskStartTip'
> = {
  closeAfterDisconnect: false,
  generateReport: true,
  autoPrintReportMsg: true,
  deviceOptions: {
    deviceName: 'Windows Desktop',
    debug: true,
  },
};
```

ç¡®è®¤åœ¨ `createAgent()` ä¸­**åŠ¨æ€åˆ›å»ºå›è°ƒ**:

```typescript
this.agent = new AgentOverWindows({
  ...this.defaultAgentConfig,
  onTaskStartTip: (tip: string) => {
    this.handleTaskStartTip(tip);
  },
});
```

### 2. æ£€æŸ¥ `agentOverWindows.ts`

**å½“å‰å®ç°** (ç›´æ¥ä¼ é€’ opts):

```typescript
constructor(opts?: AgentOverWindowsOpt) {
  const windowsDevice = new WindowsDevice(opts?.deviceOptions);
  super(windowsDevice, opts);
  this.destroyAfterDisconnectFlag = opts?.closeAfterDisconnect;
}
```

è¿™ä¸ªå®ç°**åº”è¯¥æ˜¯æ­£ç¡®çš„**ï¼Œå› ä¸ºï¼š

1. `windowsOperateService` åœ¨ `createAgent()` ä¸­åŠ¨æ€åˆ›å»ºå›è°ƒ
2. å›è°ƒå‡½æ•°ä¸­çš„ `this` æ­£ç¡®ç»‘å®šåˆ° `WindowsOperateService` å®ä¾‹
3. ç›´æ¥ä¼ é€’ opts é¿å…äº†å¤šå±‚åµŒå¥—

## ğŸ¯ æ ¹æœ¬åŸå› æ€»ç»“

æ ¹æ®å·²æœ‰çš„ä¿®å¤æ–‡æ¡£ (`CALLBACK_STACK_OVERFLOW_ROOT_CAUSE.md`)ï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

1. **ç±»å±æ€§ä¸­ä½¿ç”¨ç®­å¤´å‡½æ•°å¼•ç”¨ `this`** - å·²ä¿®å¤ âœ…
   - ä» `defaultAgentConfig` ä¸­ç§»é™¤äº† `onTaskStartTip`
   - åœ¨ `createAgent()` æ–¹æ³•ä¸­åŠ¨æ€åˆ›å»ºå›è°ƒ

2. **è¿è¡Œæ—§çš„æ„å»ºæ–‡ä»¶** - éœ€è¦é‡æ–°æ„å»º âš ï¸
   - æºä»£ç å·²ä¿®å¤ï¼Œä½† `dist/` ç›®å½•åŒ…å«æ—§ä»£ç 
   - éœ€è¦æ¸…ç†å¹¶é‡æ–°æ„å»º

## ğŸ“‹ æ£€æŸ¥æ¸…å•

æ‰§è¡Œä»¥ä¸‹æ“ä½œåï¼Œé—®é¢˜åº”è¯¥è§£å†³ï¼š

- [ ] æ¸…ç† `dist` ç›®å½•
- [ ] é‡æ–°æ„å»ºé¡¹ç›®
- [ ] é‡å¯æœåŠ¡
- [ ] æµ‹è¯•æ‰§è¡Œ Windows AI ä»»åŠ¡
- [ ] ç¡®è®¤ä¸å†å‡ºç°æ ˆæº¢å‡ºé”™è¯¯

## ğŸš¨ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœé‡æ–°æ„å»ºåé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **ç¡®è®¤æ˜¯å¦åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œ**
   - ä½¿ç”¨ `pnpm run dev` (ç›‘å¬æºä»£ç å˜åŒ–)
   - è¿˜æ˜¯ `pnpm run start` (è¿è¡Œæ„å»ºåçš„ä»£ç )

2. **æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ª Node è¿›ç¨‹**

   ```bash
   ps aux | grep node
   # ç¡®ä¿æ²¡æœ‰æ—§çš„æœåŠ¡è¿›ç¨‹ä»åœ¨è¿è¡Œ
   ```

3. **æä¾›å®Œæ•´çš„é”™è¯¯å †æ ˆ**
   - ä½¿ç”¨ `node --trace-uncaught` å¯åŠ¨æœåŠ¡
   - è·å–å®Œæ•´çš„è°ƒç”¨æ ˆä¿¡æ¯

4. **æ£€æŸ¥ package.json ä¸­çš„å¯åŠ¨å‘½ä»¤**

   ```bash
   cat package.json | grep -A 5 "scripts"
   ```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `CALLBACK_STACK_OVERFLOW_ROOT_CAUSE.md` - æ ¹æœ¬åŸå› åˆ†æ
- `CALLBACK_TIMING_ISSUE_FIX.md` - å›è°ƒæ—¶æœºé—®é¢˜ä¿®å¤
- `CALLBACK_RECURSION_FIX.md` - å›è°ƒé€’å½’é—®é¢˜ä¿®å¤

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-13  
**é—®é¢˜ç±»å‹**: æ„å»ºç¼“å­˜é—®é¢˜ + ç±»å±æ€§ç®­å¤´å‡½æ•°ä¸Šä¸‹æ–‡é—®é¢˜  
**ä¿®å¤æ–¹æ¡ˆ**: æ¸…ç†æ„å»º + åŠ¨æ€åˆ›å»ºå›è°ƒ
