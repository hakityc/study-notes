# Web 调试工具使用指南

## 📦 安装依赖

首先需要安装新添加的依赖包：

```bash
cd /Users/lebo/lebo/project/midscene-server/apps/web
pnpm install
```

## 🚀 启动服务

### 1. 启动 Server（必需）

在一个终端窗口中：

```bash
cd /Users/lebo/lebo/project/midscene-server/apps/server
pnpm dev
```

Server 将运行在：`http://localhost:3000`

### 2. 启动 Web 调试工具

在另一个终端窗口中：

```bash
cd /Users/lebo/lebo/project/midscene-server/apps/web
pnpm dev
```

Web 工具将运行在：`http://localhost:5173`（或其他可用端口）

## 🎯 快速上手

### 第一步：连接 WebSocket

1. 打开浏览器访问 Web 工具
2. 页面会自动连接到 `ws://localhost:3000/ws`
3. 右上角显示连接状态：
   - 🟢 绿色 = 已连接
   - 🟡 黄色 = 连接中
   - 🔴 红色 = 连接失败

### 第二步：选择 Action 类型

在「选择 Action 类型」下拉框中选择：

- **AI Script** ⭐ 推荐：复杂的多步骤任务流程
- **AI (简单)**：单一 AI 指令
- **Site Script**：执行 JavaScript 代码
- **Download Video**：下载视频文件
- 其他类型...

### 第三步：构建消息

#### 方式一：使用快速模板（推荐新手）

1. 点击右上角「显示历史」按钮
2. 在「快速模板」面板选择模板，例如：
   - 搜索并点击第一个结果
   - 表单填写
   - 关闭弹窗
   - 滚动加载更多
   - 检查文本内容
3. 点击「使用」按钮
4. 根据实际需求修改参数

#### 方式二：手动构建 AI Script

**示例场景：在网站上搜索并点击结果**

1. **添加任务**
   - 点击「添加任务」按钮
   - 任务名称：输入 "搜索文档"
   - 勾选「失败时继续执行」（可选）

2. **添加动作 1：点击搜索图标**
   - 点击「添加动作」
   - 动作类型：选择 `aiTap`
   - 描述：输入 "搜索图标"
   - XPath（可选）：如果知道准确路径，可填写

3. **添加动作 2：输入搜索内容**
   - 点击「添加动作」
   - 动作类型：选择 `aiInput`
   - 输入内容：输入 "小飞小飞"
   - 定位描述：输入 "搜索输入框"

4. **添加动作 3：等待结果加载**
   - 点击「添加动作」
   - 动作类型：选择 `sleep`
   - 延迟时间：输入 2000（毫秒）

5. **添加动作 4：验证结果**
   - 点击「添加动作」
   - 动作类型：选择 `aiAssert`
   - 断言描述：输入 "页面包含搜索结果"

6. **添加动作 5：点击第一个结果**
   - 点击「添加动作」
   - 动作类型：选择 `aiTap`
   - 描述：输入 "第一个搜索结果"

### 第四步：配置选项

- ✅ 勾选「启用 Loading 遮罩」：浏览器页面会显示加载动画
- Conversation ID：可保持不变，用于关联同一对话的多个消息
- Message ID：自动生成，无需修改

### 第五步：发送消息

1. 点击底部的「发送消息」按钮
2. 消息会通过 WebSocket 发送到 server
3. 右侧消息监控面板会实时显示：
   - 发送的消息（蓝色）
   - 接收到的响应（绿色=成功，红色=失败）
   - 任务执行过程中的提示信息

### 第六步：查看结果

在消息监控面板：

- 点击任意消息可以展开查看完整 JSON
- 点击「导出」可以下载所有消息记录
- 点击「清空」可以清除消息历史

## 🎨 动作类型详解

### 1. aiTap - AI 点击

点击页面上的元素。

**必填参数**：

- 描述：用自然语言描述要点击的元素，如 "搜索按钮"、"登录链接"

**可选参数**：

- XPath：精确的元素路径，如 `//*[@id="search-btn"]`

**使用场景**：

- 点击按钮、链接、图标
- 选择下拉选项
- 触发交互事件

### 2. aiInput - AI 输入

在输入框中输入文本。

**必填参数**：

- 输入内容：要输入的文本
- 定位描述：描述输入框位置，如 "用户名输入框"、"搜索框"

**可选参数**：

- XPath：精确的元素路径

**使用场景**：

- 填写表单
- 搜索
- 输入账号密码

### 3. aiAssert - AI 断言

验证页面状态或内容。

**必填参数**：

- 断言描述：要验证的条件，如 "页面包含'成功'字样"、"登录按钮可见"

**使用场景**：

- 验证操作结果
- 检查页面状态
- 确认内容显示

### 4. sleep - 等待

等待指定时间。

**必填参数**：

- 延迟时间：毫秒数，如 2000 表示 2 秒

**使用场景**：

- 等待页面加载
- 等待动画完成
- 避免操作过快

### 5. aiHover - AI 悬停

鼠标悬停在元素上。

**必填参数**：

- 描述：要悬停的元素

**可选参数**：

- XPath：精确路径

**使用场景**：

- 触发悬停菜单
- 显示工具提示
- 触发悬停效果

### 6. aiScroll - AI 滚动

滚动页面或元素。

**必填参数**：

- 滚动方向：up（向上）、down（向下）、left（向左）、right（向右）
- 滚动类型：
  - once：滚动固定距离
  - untilBottom：滚动到底部
  - untilTop：滚动到顶部
  - untilLeft：滚动到最左
  - untilRight：滚动到最右

**可选参数**：

- 距离：仅在 scrollType=once 时需要，单位像素
- 定位描述：滚动的容器元素
- 深度思考模式：更精确的滚动控制

**使用场景**：

- 加载更多内容
- 滚动到页面特定位置
- 触发懒加载

### 7. aiWaitFor - AI 等待条件

等待直到某个条件满足。

**必填参数**：

- 条件描述：要等待的条件，如 "页面加载完成"、"弹窗出现"

**可选参数**：

- 超时时间：默认 15000 毫秒
- 检查间隔：默认 3000 毫秒

**使用场景**：

- 等待异步内容加载
- 等待弹窗出现
- 等待页面跳转

### 8. aiKeyboardPress - AI 按键

模拟键盘按键。

**必填参数**：

- 按键：键名，如 "Enter"、"Tab"、"Escape"、"ArrowDown"

**可选参数**：

- 定位描述：在哪个元素上按键
- 深度思考模式：更精确的按键控制

**使用场景**：

- 提交表单（Enter）
- 关闭对话框（Escape）
- 导航（Tab、方向键）

## 💡 高级技巧

### 技巧 1：复用 Conversation ID

如果你要执行多个相关的操作，可以保持 Conversation ID 不变：

1. 发送第一条消息
2. 不刷新页面，修改参数
3. 再次发送，server 可以关联这些消息

### 技巧 2：使用历史记录

系统会自动保存最近 10 条消息：

1. 点击「显示历史」
2. 找到之前的配置
3. 点击上传图标 📤 快速加载
4. 稍作修改后重新发送

### 技巧 3：JSON 模式调试

如果表单构建的消息有问题：

1. 切换到「JSON 模式」标签
2. 查看生成的完整 JSON
3. 对比 server 的日志输出
4. 点击「复制」保存 JSON

### 技巧 4：组合多个任务

一个 AI Script 可以包含多个任务：

```
任务 1: 登录
  ├─ aiInput: 用户名
  ├─ aiInput: 密码
  └─ aiTap: 登录按钮

任务 2: 搜索
  ├─ aiTap: 搜索图标
  └─ aiInput: 搜索内容

任务 3: 验证
  └─ aiAssert: 检查结果
```

### 技巧 5：错误容错

勾选「失败时继续执行」可以让任务在某个步骤失败时继续执行后续步骤：

- ✅ 适用于：关闭可能不存在的弹窗
- ❌ 不适用于：登录必须成功才能继续的场景

### 技巧 6：导出和分享

可以导出消息记录用于：

- 调试分析
- 团队分享
- 问题复现
- 文档记录

## 🔍 故障排查

### 问题 1：WebSocket 连接失败

**症状**：右上角显示红色「连接失败」

**解决方法**：

1. 检查 server 是否启动：

   ```bash
   cd apps/server
   pnpm dev
   ```

2. 检查端口是否正确（默认 3000）
3. 查看浏览器控制台的错误信息
4. 确认防火墙没有阻止连接

### 问题 2：消息发送后无响应

**症状**：发送消息后，消息监控没有显示响应

**解决方法**：

1. 查看 server 终端的日志输出
2. 检查消息格式是否正确（切换到 JSON 模式查看）
3. 确认 action 类型是否拼写正确
4. 查看 server 的错误提示

### 问题 3：AI 动作执行失败

**症状**：收到错误响应，任务未完成

**解决方法**：

1. 检查描述是否清晰准确
2. 确认页面元素是否存在
3. 增加 sleep 等待时间
4. 使用 XPath 精确定位
5. 查看 server 日志的详细错误信息

### 问题 4：JSON 格式错误

**症状**：JSON 预览显示「无效」

**解决方法**：

1. 检查必填字段是否填写
2. 确认数值类型正确（延迟时间应为数字）
3. 参考快速模板的格式
4. 使用表单模式而不是直接编辑 JSON

## 📚 更多资源

- **Server 文档**：`apps/server/README.md`
- **设计方案**：`apps/server/docs/WEB_DEBUG_TOOL_DESIGN.md`
- **WebSocket API**：`apps/server/src/types/websocket.ts`

## 🎉 开始使用

现在你可以：

1. 安装依赖：`pnpm install`
2. 启动 server：`cd apps/server && pnpm dev`
3. 启动 web：`cd apps/web && pnpm dev`
4. 打开浏览器，开始调试！

祝你使用愉快！🚀
