# Web é¡¹ç›®çŠ¶æ€ç®¡ç†ä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®é‡‡ç”¨ **Zustand + TanStack Query** ç»„åˆæ–¹æ¡ˆè¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚

## ğŸ“‹ ç›®å½•

- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [Zustand ä½¿ç”¨](#zustand-ä½¿ç”¨)
- [React Query ä½¿ç”¨](#react-query-ä½¿ç”¨)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ›  æŠ€æœ¯æ ˆ

### Zustand (å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†)

- **ç‰ˆæœ¬**: 5.0.8
- **ç”¨é€”**: ç®¡ç†å®¢æˆ·ç«¯ UI çŠ¶æ€ã€è¡¨å•æ•°æ®ã€ç”¨æˆ·é…ç½®ç­‰
- **ç‰¹ç‚¹**:
  - æç®€ APIï¼Œä½“ç§¯å°ï¼ˆ~1KB gzippedï¼‰
  - æ— éœ€ Provider åŒ…è£¹
  - æ”¯æŒæŒä¹…åŒ–å­˜å‚¨ï¼ˆlocalStorageï¼‰
  - TypeScript å®Œç¾æ”¯æŒ

### TanStack Query (æœåŠ¡å™¨çŠ¶æ€ç®¡ç†)

- **ç‰ˆæœ¬**: 5.90.3
- **ç”¨é€”**: ç®¡ç†æœåŠ¡å™¨æ•°æ®è·å–ã€ç¼“å­˜ã€åŒæ­¥
- **ç‰¹ç‚¹**:
  - è‡ªåŠ¨ç¼“å­˜å’Œé‡æ–°éªŒè¯
  - å†…ç½®åŠ è½½å’Œé”™è¯¯çŠ¶æ€
  - è¯·æ±‚å»é‡å’Œå¹¶å‘æ§åˆ¶
  - å¼ºå¤§çš„ DevTools

---

## ğŸ“ ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ stores/                    # Zustand stores
â”‚   â”œâ”€â”€ debugStore.ts         # Debug é¡µé¢çŠ¶æ€
â”‚   â”œâ”€â”€ promptStore.ts        # Prompt ä¼˜åŒ–é¡µé¢çŠ¶æ€
â”‚   â””â”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePromptOptimizeApi.ts  # API hooks (React Query)
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ index.ts          # API hooks ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ QueryProvider.tsx     # React Query Provider
â”‚   â””â”€â”€ index.ts
â””â”€â”€ pages/                     # é¡µé¢ç»„ä»¶
```

---

## ğŸ¯ Zustand ä½¿ç”¨

### 1. Store å®šä¹‰

#### Debug Store ç¤ºä¾‹ (`debugStore.ts`)

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface DebugState {
  // çŠ¶æ€
  endpoint: string;
  action: WebSocketAction;
  tasks: Task[];

  // Actions
  setEndpoint: (endpoint: string) => void;
  setAction: (action: WebSocketAction) => void;
  setTasks: (tasks: Task[]) => void;
}

export const useDebugStore = create<DebugState>()(
  persist(
    (set) => ({
      // åˆå§‹çŠ¶æ€
      endpoint: 'ws://localhost:3000/ws',
      action: 'aiScript',
      tasks: [],

      // Actions
      setEndpoint: (endpoint) => set({ endpoint }),
      setAction: (action) => set({ action }),
      setTasks: (tasks) => set({ tasks }),
    }),
    {
      name: 'debug-storage',  // localStorage key
      partialize: (state) => ({  // é€‰æ‹©æ€§æŒä¹…åŒ–
        endpoint: state.endpoint,
        action: state.action,
        // tasks ä¸æŒä¹…åŒ–
      }),
    },
  ),
);
```

### 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
import { useDebugStore } from '@/stores';

function MyComponent() {
  // é€‰æ‹©æ€§è®¢é˜…éœ€è¦çš„çŠ¶æ€
  const endpoint = useDebugStore((state) => state.endpoint);
  const setEndpoint = useDebugStore((state) => state.setEndpoint);

  // æˆ–è€…æ‰¹é‡è·å–
  const { action, setAction, tasks, setTasks } = useDebugStore();

  return (
    <div>
      <input
        value={endpoint}
        onChange={(e) => setEndpoint(e.target.value)}
      />
    </div>
  );
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

```tsx
// âœ… å¥½ï¼šåªè®¢é˜…éœ€è¦çš„å­—æ®µ
const endpoint = useDebugStore((state) => state.endpoint);

// âŒ ä¸å¥½ï¼šè®¢é˜…æ•´ä¸ª storeï¼ˆæ¯æ¬¡æ›´æ–°éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼‰
const store = useDebugStore();
```

### 4. å¤æ‚æ›´æ–°é€»è¾‘

```tsx
// åœ¨ store ä¸­å®šä¹‰å¤æ‚çš„æ›´æ–°é€»è¾‘
const useDebugStore = create<DebugState>()((set, get) => ({
  // ...

  // å¤æ‚æ›´æ–°
  loadHistory: (item: HistoryItem) => {
    const { tasks } = get();  // è·å–å½“å‰çŠ¶æ€
    set({
      action: item.message.payload.action,
      tasks: [...tasks, ...item.tasks],
    });
  },
}));
```

---

## ğŸŒ React Query ä½¿ç”¨

### 1. API Hook å®šä¹‰

```typescript
// hooks/usePromptOptimizeApi.ts
import { useMutation } from '@tanstack/react-query';

interface OptimizeParams {
  prompt: string;
  targetAction: string;
}

const optimizePrompt = async (params: OptimizeParams) => {
  const response = await fetch('/api/prompt-optimize', {
    method: 'POST',
    body: JSON.stringify(params),
  });
  return response.json();
};

export function usePromptOptimizeApi() {
  return useMutation({
    mutationFn: optimizePrompt,
    onSuccess: (data) => {
      console.log('ä¼˜åŒ–æˆåŠŸ:', data);
    },
    onError: (error) => {
      console.error('ä¼˜åŒ–å¤±è´¥:', error);
    },
  });
}
```

### 2. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ Mutation

```tsx
import { usePromptOptimizeApi } from '@/hooks/usePromptOptimizeApi';

function MyComponent() {
  const { mutate, isPending, isError, isSuccess, data } = usePromptOptimizeApi();

  const handleOptimize = () => {
    mutate(
      { prompt: 'test', targetAction: 'aiTap' },
      {
        onSuccess: (data) => {
          // æˆåŠŸå›è°ƒ
          console.log(data);
        },
        onError: (error) => {
          // é”™è¯¯å›è°ƒ
          console.error(error);
        },
      }
    );
  };

  return (
    <div>
      <button onClick={handleOptimize} disabled={isPending}>
        {isPending ? 'ä¼˜åŒ–ä¸­...' : 'å¼€å§‹ä¼˜åŒ–'}
      </button>
      {isError && <p>ä¼˜åŒ–å¤±è´¥</p>}
      {isSuccess && <p>ä¼˜åŒ–æˆåŠŸ: {data.optimized}</p>}
    </div>
  );
}
```

### 3. Query (GET è¯·æ±‚) ç¤ºä¾‹

```typescript
// hooks/useTemplatesApi.ts
import { useQuery } from '@tanstack/react-query';

const fetchTemplates = async () => {
  const response = await fetch('/api/templates');
  return response.json();
};

export function useTemplatesApi() {
  return useQuery({
    queryKey: ['templates'],  // å”¯ä¸€æ ‡è¯†
    queryFn: fetchTemplates,
    staleTime: 1000 * 60 * 5,  // 5 åˆ†é’Ÿå†…ä¸é‡æ–°è·å–
    gcTime: 1000 * 60 * 10,     // 10 åˆ†é’Ÿåæ¸…é™¤ç¼“å­˜
  });
}

// ä½¿ç”¨
function MyComponent() {
  const { data, isLoading, isError, refetch } = useTemplatesApi();

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;
  if (isError) return <div>åŠ è½½å¤±è´¥</div>;

  return (
    <div>
      {data.map(template => <div key={template.id}>{template.name}</div>)}
      <button onClick={() => refetch()}>åˆ·æ–°</button>
    </div>
  );
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. çŠ¶æ€ç®¡ç†åˆ†å·¥

| çŠ¶æ€ç±»å‹ | ä½¿ç”¨æ–¹æ¡ˆ | ç¤ºä¾‹ |
|---------|---------|------|
| UI çŠ¶æ€ | Zustand | æ¨¡æ€æ¡†å¼€å…³ã€è¡¨å•è¾“å…¥ã€é€‰é¡¹å¡é€‰æ‹© |
| è¡¨å•æ•°æ® | Zustand | æœªæäº¤çš„è¡¨å•ã€è‰ç¨¿ |
| ç”¨æˆ·é…ç½® | Zustand | ä¸»é¢˜ã€è¯­è¨€ã€åå¥½è®¾ç½® |
| æœåŠ¡å™¨æ•°æ® | React Query | API æ•°æ®ã€åˆ—è¡¨ã€è¯¦æƒ… |
| å¼‚æ­¥æ“ä½œ | React Query | POST/PUT/DELETE è¯·æ±‚ |

### 2. Store è®¾è®¡åŸåˆ™

```typescript
// âœ… å¥½ï¼šæ¯ä¸ªé¡µé¢/æ¨¡å—ç‹¬ç«‹çš„ store
useDebugStore
usePromptStore
useSettingsStore

// âŒ ä¸å¥½ï¼šå…¨å±€å¤§ store
useGlobalStore (åŒ…å«æ‰€æœ‰çŠ¶æ€)

// âœ… å¥½ï¼šæ‰å¹³åŒ–çŠ¶æ€
{
  inputPrompt: string;
  outputPrompt: string;
}

// âŒ ä¸å¥½ï¼šè¿‡åº¦åµŒå¥—
{
  form: {
    prompts: {
      input: string;
      output: string;
    }
  }
}
```

### 3. æŒä¹…åŒ–ç­–ç•¥

```typescript
persist(
  (set) => ({ /* ... */ }),
  {
    name: 'storage-key',
    partialize: (state) => ({
      // åªæŒä¹…åŒ–éœ€è¦çš„å­—æ®µ
      theme: state.theme,
      language: state.language,
      // ä¸æŒä¹…åŒ–ä¸´æ—¶çŠ¶æ€
      // isLoading: state.isLoading,
    }),
  }
)
```

### 4. React Query ç¼“å­˜ç­–ç•¥

```typescript
// å®æ—¶æ•°æ®ï¼šçŸ­ç¼“å­˜æ—¶é—´
useQuery({
  queryKey: ['live-data'],
  staleTime: 0,  // ç«‹å³è¿‡æœŸ
  gcTime: 1000 * 30,  // 30 ç§’åæ¸…é™¤
});

// é™æ€æ•°æ®ï¼šé•¿ç¼“å­˜æ—¶é—´
useQuery({
  queryKey: ['static-data'],
  staleTime: Infinity,  // æ°¸ä¸è¿‡æœŸ
  gcTime: Infinity,  // æ°¸ä¸æ¸…é™¤
});

// å¸¸è§„æ•°æ®ï¼šé€‚ä¸­ç¼“å­˜
useQuery({
  queryKey: ['normal-data'],
  staleTime: 1000 * 60 * 5,  // 5 åˆ†é’Ÿ
  gcTime: 1000 * 60 * 10,  // 10 åˆ†é’Ÿ
});
```

### 5. é”™è¯¯å¤„ç†å’Œé™çº§

```typescript
const handleOptimize = () => {
  mutate(params, {
    onError: (error) => {
      // åç«¯å¤±è´¥æ—¶é™çº§åˆ°æœ¬åœ°é€»è¾‘
      const fallbackResult = localOptimize(params);
      setResult(fallbackResult);
    },
  });
};
```

### 6. ç»„åˆä½¿ç”¨ç¤ºä¾‹

```tsx
function SmartComponent() {
  // Zustand: ç®¡ç† UI çŠ¶æ€
  const { inputValue, setInputValue } = useFormStore();

  // React Query: ç®¡ç†æœåŠ¡å™¨è¯·æ±‚
  const { mutate, isPending } = useSubmitApi();

  const handleSubmit = () => {
    mutate(
      { value: inputValue },
      {
        onSuccess: () => {
          setInputValue('');  // æ¸…ç©ºè¡¨å•
        },
      }
    );
  };

  return (
    <>
      <input
        value={inputValue}
        onChange={(e) => setInputValue(e.target.value)}
      />
      <button onClick={handleSubmit} disabled={isPending}>
        æäº¤
      </button>
    </>
  );
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Zustand å®˜æ–¹æ–‡æ¡£](https://docs.pmnd.rs/zustand/getting-started/introduction)
- [TanStack Query å®˜æ–¹æ–‡æ¡£](https://tanstack.com/query/latest)
- [Zustand ä¸­æ–‡æ–‡æ¡£](https://awesomedevin.github.io/zustand-vue/docs/introduce/what-is-zustand)

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### Zustand DevTools

```typescript
import { devtools } from 'zustand/middleware';

const useDebugStore = create<DebugState>()(
  devtools(
    persist(
      (set) => ({ /* ... */ }),
      { name: 'debug-storage' }
    ),
    { name: 'DebugStore' }  // DevTools ä¸­æ˜¾ç¤ºçš„åç§°
  )
);
```

### React Query DevTools

```tsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

<QueryProvider>
  <App />
  <ReactQueryDevtools initialIsOpen={false} />
</QueryProvider>
```

---

## ğŸ‰ æ€»ç»“

- âœ… **Zustand** ç”¨äºå®¢æˆ·ç«¯çŠ¶æ€ï¼Œç®€å•é«˜æ•ˆ
- âœ… **React Query** ç”¨äºæœåŠ¡å™¨çŠ¶æ€ï¼ŒåŠŸèƒ½å¼ºå¤§
- âœ… ä¸¤è€…é…åˆä½¿ç”¨ï¼ŒèŒè´£æ¸…æ™°
- âœ… æŒä¹…åŒ–å’Œç¼“å­˜ç­–ç•¥æ˜ç¡®
- âœ… æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†å®Œå–„

Happy Coding! ğŸš€
