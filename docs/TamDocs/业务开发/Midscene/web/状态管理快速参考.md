# 状态管理快速参考

## 🚀 快速开始

### 1. 创建 Zustand Store

```typescript
// stores/myStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface MyState {
  count: number;
  text: string;
  increment: () => void;
  setText: (text: string) => void;
}

export const useMyStore = create<MyState>()(
  persist(
    (set) => ({
      count: 0,
      text: '',
      increment: () => set((state) => ({ count: state.count + 1 })),
      setText: (text) => set({ text }),
    }),
    {
      name: 'my-storage',
    }
  )
);
```

### 2. 创建 React Query Hook

```typescript
// hooks/useMyApi.ts
import { useMutation, useQuery } from '@tanstack/react-query';

// GET 请求
export function useGetData() {
  return useQuery({
    queryKey: ['data'],
    queryFn: async () => {
      const res = await fetch('/api/data');
      return res.json();
    },
  });
}

// POST 请求
export function usePostData() {
  return useMutation({
    mutationFn: async (data: any) => {
      const res = await fetch('/api/data', {
        method: 'POST',
        body: JSON.stringify(data),
      });
      return res.json();
    },
  });
}
```

### 3. 在组件中使用

```tsx
import { useMyStore } from '@/stores/myStore';
import { useGetData, usePostData } from '@/hooks/useMyApi';

function MyComponent() {
  // Zustand
  const { count, text, increment, setText } = useMyStore();
  
  // React Query
  const { data, isLoading } = useGetData();
  const { mutate, isPending } = usePostData();
  
  return (
    <div>
      {/* Zustand 状态 */}
      <p>Count: {count}</p>
      <button onClick={increment}>+1</button>
      
      {/* React Query 数据 */}
      {isLoading ? '加载中...' : data?.name}
      
      <button 
        onClick={() => mutate({ name: text })}
        disabled={isPending}
      >
        提交
      </button>
    </div>
  );
}
```

---

## 📋 常用模式

### 模式 1: 表单状态管理

```typescript
// stores/formStore.ts
export const useFormStore = create<FormState>()((set) => ({
  name: '',
  email: '',
  setName: (name) => set({ name }),
  setEmail: (email) => set({ email }),
  reset: () => set({ name: '', email: '' }),
}));

// Component
function FormComponent() {
  const { name, email, setName, setEmail, reset } = useFormStore();
  const { mutate, isPending } = useSubmitForm();
  
  const handleSubmit = () => {
    mutate({ name, email }, {
      onSuccess: () => reset(),
    });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input value={name} onChange={e => setName(e.target.value)} />
      <input value={email} onChange={e => setEmail(e.target.value)} />
      <button disabled={isPending}>提交</button>
    </form>
  );
}
```

### 模式 2: 列表管理

```typescript
// hooks/useItemsApi.ts
export function useItems() {
  return useQuery({
    queryKey: ['items'],
    queryFn: fetchItems,
  });
}

export function useAddItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: addItem,
    onSuccess: () => {
      // 刷新列表
      queryClient.invalidateQueries({ queryKey: ['items'] });
    },
  });
}

// Component
function ItemList() {
  const { data: items, isLoading } = useItems();
  const { mutate: addItem } = useAddItem();
  
  if (isLoading) return <div>Loading...</div>;
  
  return (
    <>
      {items.map(item => <div key={item.id}>{item.name}</div>)}
      <button onClick={() => addItem({ name: 'New' })}>
        添加
      </button>
    </>
  );
}
```

### 模式 3: 全局配置

```typescript
// stores/configStore.ts
export const useConfigStore = create<ConfigState>()(
  persist(
    (set) => ({
      theme: 'light',
      language: 'zh',
      setTheme: (theme) => set({ theme }),
      setLanguage: (language) => set({ language }),
    }),
    {
      name: 'app-config',
    }
  )
);
```

### 模式 4: 模态框状态

```typescript
// stores/modalStore.ts
export const useModalStore = create<ModalState>()((set) => ({
  isOpen: false,
  data: null,
  open: (data) => set({ isOpen: true, data }),
  close: () => set({ isOpen: false, data: null }),
}));

// Component
function MyComponent() {
  const { open } = useModalStore();
  return <button onClick={() => open({ id: 1 })}>打开</button>;
}

function Modal() {
  const { isOpen, data, close } = useModalStore();
  if (!isOpen) return null;
  return <div onClick={close}>{data.id}</div>;
}
```

### 模式 5: 乐观更新

```typescript
export function useUpdateItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: updateItem,
    // 乐观更新
    onMutate: async (newItem) => {
      // 取消正在进行的查询
      await queryClient.cancelQueries({ queryKey: ['items'] });
      
      // 保存旧数据
      const previousItems = queryClient.getQueryData(['items']);
      
      // 乐观更新
      queryClient.setQueryData(['items'], (old: any[]) => 
        old.map(item => item.id === newItem.id ? newItem : item)
      );
      
      return { previousItems };
    },
    // 失败时回滚
    onError: (err, newItem, context) => {
      queryClient.setQueryData(['items'], context.previousItems);
    },
    // 成功后重新获取
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['items'] });
    },
  });
}
```

---

## 🎯 选择器优化

```typescript
// ❌ 不好：每次更新都重新渲染
function Bad() {
  const store = useMyStore();
  return <div>{store.name}</div>;
}

// ✅ 好：只在 name 变化时重新渲染
function Good() {
  const name = useMyStore(state => state.name);
  return <div>{name}</div>;
}

// ✅ 更好：使用 shallow 比较
import { shallow } from 'zustand/shallow';

function Better() {
  const { name, age } = useMyStore(
    state => ({ name: state.name, age: state.age }),
    shallow
  );
  return <div>{name} - {age}</div>;
}
```

---

## 🔄 异步操作

### Zustand 中的异步

```typescript
export const useStore = create<State>()((set, get) => ({
  items: [],
  loading: false,
  
  fetchItems: async () => {
    set({ loading: true });
    try {
      const items = await fetchApi();
      set({ items, loading: false });
    } catch (error) {
      set({ loading: false });
    }
  },
}));
```

### React Query 中的异步（推荐）

```typescript
export function useItems() {
  return useQuery({
    queryKey: ['items'],
    queryFn: fetchApi,
  });
}

// Component
function Items() {
  const { data, isLoading, error } = useItems();
  
  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  return <div>{data.map(...)}</div>;
}
```

---

## 🛠 调试技巧

### 1. 查看 Zustand 状态

```typescript
// 开发环境下打印状态
const state = useMyStore.getState();
console.log('Current state:', state);

// 订阅状态变化
useMyStore.subscribe(
  state => console.log('State changed:', state)
);
```

### 2. React Query DevTools

```tsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

function App() {
  return (
    <>
      <YourApp />
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} />
      )}
    </>
  );
}
```

### 3. 查看查询状态

```typescript
const queryClient = useQueryClient();

// 获取查询状态
const queryState = queryClient.getQueryState(['items']);
console.log('Query state:', queryState);

// 获取查询数据
const queryData = queryClient.getQueryData(['items']);
console.log('Query data:', queryData);
```

---

## ⚡ 性能优化清单

- [ ] 使用选择器避免不必要的重新渲染
- [ ] 合理设置 `staleTime` 和 `gcTime`
- [ ] 避免在 render 中直接调用异步函数
- [ ] 使用 `shallow` 比较对象/数组
- [ ] 考虑数据分页和无限滚动
- [ ] 合理使用乐观更新
- [ ] 避免频繁的 `invalidateQueries`
- [ ] 使用 `enabled` 控制查询时机

---

## 📝 类型定义技巧

```typescript
// 从 store 中导出类型
export type MyState = ReturnType<typeof useMyStore.getState>;
export type MyActions = Pick<MyState, 'increment' | 'decrement'>;

// API 类型定义
interface ApiResponse<T> {
  data: T;
  message: string;
  code: number;
}

// Hook 类型推导
export function useTypedQuery<T>() {
  return useQuery<ApiResponse<T>>({
    // ...
  });
}
```

---

## 🎉 实战示例

完整的增删改查示例：

```typescript
// stores/todosStore.ts
export const useTodosStore = create<TodosState>()((set) => ({
  filter: 'all',
  setFilter: (filter) => set({ filter }),
}));

// hooks/useTodosApi.ts
export function useTodos() {
  const filter = useTodosStore(state => state.filter);
  return useQuery({
    queryKey: ['todos', filter],
    queryFn: () => fetchTodos(filter),
  });
}

export function useAddTodo() {
  return useMutation({
    mutationFn: addTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

export function useUpdateTodo() {
  return useMutation({
    mutationFn: updateTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

export function useDeleteTodo() {
  return useMutation({
    mutationFn: deleteTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// Component
function TodoApp() {
  const { filter, setFilter } = useTodosStore();
  const { data: todos, isLoading } = useTodos();
  const { mutate: addTodo } = useAddTodo();
  const { mutate: updateTodo } = useUpdateTodo();
  const { mutate: deleteTodo } = useDeleteTodo();
  
  if (isLoading) return <div>Loading...</div>;
  
  return (
    <div>
      <select value={filter} onChange={e => setFilter(e.target.value)}>
        <option value="all">全部</option>
        <option value="active">进行中</option>
        <option value="completed">已完成</option>
      </select>
      
      {todos.map(todo => (
        <div key={todo.id}>
          <span>{todo.title}</span>
          <button onClick={() => updateTodo(todo)}>更新</button>
          <button onClick={() => deleteTodo(todo.id)}>删除</button>
        </div>
      ))}
      
      <button onClick={() => addTodo({ title: 'New Todo' })}>
        添加
      </button>
    </div>
  );
}
```

---

需要更多帮助？查看[完整使用指南](./状态管理使用指南.md) 📚
