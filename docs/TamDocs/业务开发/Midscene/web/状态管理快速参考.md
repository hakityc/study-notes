# çŠ¶æ€ç®¡ç†å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»º Zustand Store

```typescript
// stores/myStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface MyState {
  count: number;
  text: string;
  increment: () => void;
  setText: (text: string) => void;
}

export const useMyStore = create<MyState>()(
  persist(
    (set) => ({
      count: 0,
      text: '',
      increment: () => set((state) => ({ count: state.count + 1 })),
      setText: (text) => set({ text }),
    }),
    {
      name: 'my-storage',
    }
  )
);
```

### 2. åˆ›å»º React Query Hook

```typescript
// hooks/useMyApi.ts
import { useMutation, useQuery } from '@tanstack/react-query';

// GET è¯·æ±‚
export function useGetData() {
  return useQuery({
    queryKey: ['data'],
    queryFn: async () => {
      const res = await fetch('/api/data');
      return res.json();
    },
  });
}

// POST è¯·æ±‚
export function usePostData() {
  return useMutation({
    mutationFn: async (data: any) => {
      const res = await fetch('/api/data', {
        method: 'POST',
        body: JSON.stringify(data),
      });
      return res.json();
    },
  });
}
```

### 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
import { useMyStore } from '@/stores/myStore';
import { useGetData, usePostData } from '@/hooks/useMyApi';

function MyComponent() {
  // Zustand
  const { count, text, increment, setText } = useMyStore();
  
  // React Query
  const { data, isLoading } = useGetData();
  const { mutate, isPending } = usePostData();
  
  return (
    <div>
      {/* Zustand çŠ¶æ€ */}
      <p>Count: {count}</p>
      <button onClick={increment}>+1</button>
      
      {/* React Query æ•°æ® */}
      {isLoading ? 'åŠ è½½ä¸­...' : data?.name}
      
      <button 
        onClick={() => mutate({ name: text })}
        disabled={isPending}
      >
        æäº¤
      </button>
    </div>
  );
}
```

---

## ğŸ“‹ å¸¸ç”¨æ¨¡å¼

### æ¨¡å¼ 1: è¡¨å•çŠ¶æ€ç®¡ç†

```typescript
// stores/formStore.ts
export const useFormStore = create<FormState>()((set) => ({
  name: '',
  email: '',
  setName: (name) => set({ name }),
  setEmail: (email) => set({ email }),
  reset: () => set({ name: '', email: '' }),
}));

// Component
function FormComponent() {
  const { name, email, setName, setEmail, reset } = useFormStore();
  const { mutate, isPending } = useSubmitForm();
  
  const handleSubmit = () => {
    mutate({ name, email }, {
      onSuccess: () => reset(),
    });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input value={name} onChange={e => setName(e.target.value)} />
      <input value={email} onChange={e => setEmail(e.target.value)} />
      <button disabled={isPending}>æäº¤</button>
    </form>
  );
}
```

### æ¨¡å¼ 2: åˆ—è¡¨ç®¡ç†

```typescript
// hooks/useItemsApi.ts
export function useItems() {
  return useQuery({
    queryKey: ['items'],
    queryFn: fetchItems,
  });
}

export function useAddItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: addItem,
    onSuccess: () => {
      // åˆ·æ–°åˆ—è¡¨
      queryClient.invalidateQueries({ queryKey: ['items'] });
    },
  });
}

// Component
function ItemList() {
  const { data: items, isLoading } = useItems();
  const { mutate: addItem } = useAddItem();
  
  if (isLoading) return <div>Loading...</div>;
  
  return (
    <>
      {items.map(item => <div key={item.id}>{item.name}</div>)}
      <button onClick={() => addItem({ name: 'New' })}>
        æ·»åŠ 
      </button>
    </>
  );
}
```

### æ¨¡å¼ 3: å…¨å±€é…ç½®

```typescript
// stores/configStore.ts
export const useConfigStore = create<ConfigState>()(
  persist(
    (set) => ({
      theme: 'light',
      language: 'zh',
      setTheme: (theme) => set({ theme }),
      setLanguage: (language) => set({ language }),
    }),
    {
      name: 'app-config',
    }
  )
);
```

### æ¨¡å¼ 4: æ¨¡æ€æ¡†çŠ¶æ€

```typescript
// stores/modalStore.ts
export const useModalStore = create<ModalState>()((set) => ({
  isOpen: false,
  data: null,
  open: (data) => set({ isOpen: true, data }),
  close: () => set({ isOpen: false, data: null }),
}));

// Component
function MyComponent() {
  const { open } = useModalStore();
  return <button onClick={() => open({ id: 1 })}>æ‰“å¼€</button>;
}

function Modal() {
  const { isOpen, data, close } = useModalStore();
  if (!isOpen) return null;
  return <div onClick={close}>{data.id}</div>;
}
```

### æ¨¡å¼ 5: ä¹è§‚æ›´æ–°

```typescript
export function useUpdateItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: updateItem,
    // ä¹è§‚æ›´æ–°
    onMutate: async (newItem) => {
      // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
      await queryClient.cancelQueries({ queryKey: ['items'] });
      
      // ä¿å­˜æ—§æ•°æ®
      const previousItems = queryClient.getQueryData(['items']);
      
      // ä¹è§‚æ›´æ–°
      queryClient.setQueryData(['items'], (old: any[]) => 
        old.map(item => item.id === newItem.id ? newItem : item)
      );
      
      return { previousItems };
    },
    // å¤±è´¥æ—¶å›æ»š
    onError: (err, newItem, context) => {
      queryClient.setQueryData(['items'], context.previousItems);
    },
    // æˆåŠŸåé‡æ–°è·å–
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: ['items'] });
    },
  });
}
```

---

## ğŸ¯ é€‰æ‹©å™¨ä¼˜åŒ–

```typescript
// âŒ ä¸å¥½ï¼šæ¯æ¬¡æ›´æ–°éƒ½é‡æ–°æ¸²æŸ“
function Bad() {
  const store = useMyStore();
  return <div>{store.name}</div>;
}

// âœ… å¥½ï¼šåªåœ¨ name å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
function Good() {
  const name = useMyStore(state => state.name);
  return <div>{name}</div>;
}

// âœ… æ›´å¥½ï¼šä½¿ç”¨ shallow æ¯”è¾ƒ
import { shallow } from 'zustand/shallow';

function Better() {
  const { name, age } = useMyStore(
    state => ({ name: state.name, age: state.age }),
    shallow
  );
  return <div>{name} - {age}</div>;
}
```

---

## ğŸ”„ å¼‚æ­¥æ“ä½œ

### Zustand ä¸­çš„å¼‚æ­¥

```typescript
export const useStore = create<State>()((set, get) => ({
  items: [],
  loading: false,
  
  fetchItems: async () => {
    set({ loading: true });
    try {
      const items = await fetchApi();
      set({ items, loading: false });
    } catch (error) {
      set({ loading: false });
    }
  },
}));
```

### React Query ä¸­çš„å¼‚æ­¥ï¼ˆæ¨èï¼‰

```typescript
export function useItems() {
  return useQuery({
    queryKey: ['items'],
    queryFn: fetchApi,
  });
}

// Component
function Items() {
  const { data, isLoading, error } = useItems();
  
  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  return <div>{data.map(...)}</div>;
}
```

---

## ğŸ›  è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Zustand çŠ¶æ€

```typescript
// å¼€å‘ç¯å¢ƒä¸‹æ‰“å°çŠ¶æ€
const state = useMyStore.getState();
console.log('Current state:', state);

// è®¢é˜…çŠ¶æ€å˜åŒ–
useMyStore.subscribe(
  state => console.log('State changed:', state)
);
```

### 2. React Query DevTools

```tsx
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

function App() {
  return (
    <>
      <YourApp />
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} />
      )}
    </>
  );
}
```

### 3. æŸ¥çœ‹æŸ¥è¯¢çŠ¶æ€

```typescript
const queryClient = useQueryClient();

// è·å–æŸ¥è¯¢çŠ¶æ€
const queryState = queryClient.getQueryState(['items']);
console.log('Query state:', queryState);

// è·å–æŸ¥è¯¢æ•°æ®
const queryData = queryClient.getQueryData(['items']);
console.log('Query data:', queryData);
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–æ¸…å•

- [ ] ä½¿ç”¨é€‰æ‹©å™¨é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- [ ] åˆç†è®¾ç½® `staleTime` å’Œ `gcTime`
- [ ] é¿å…åœ¨ render ä¸­ç›´æ¥è°ƒç”¨å¼‚æ­¥å‡½æ•°
- [ ] ä½¿ç”¨ `shallow` æ¯”è¾ƒå¯¹è±¡/æ•°ç»„
- [ ] è€ƒè™‘æ•°æ®åˆ†é¡µå’Œæ— é™æ»šåŠ¨
- [ ] åˆç†ä½¿ç”¨ä¹è§‚æ›´æ–°
- [ ] é¿å…é¢‘ç¹çš„ `invalidateQueries`
- [ ] ä½¿ç”¨ `enabled` æ§åˆ¶æŸ¥è¯¢æ—¶æœº

---

## ğŸ“ ç±»å‹å®šä¹‰æŠ€å·§

```typescript
// ä» store ä¸­å¯¼å‡ºç±»å‹
export type MyState = ReturnType<typeof useMyStore.getState>;
export type MyActions = Pick<MyState, 'increment' | 'decrement'>;

// API ç±»å‹å®šä¹‰
interface ApiResponse<T> {
  data: T;
  message: string;
  code: number;
}

// Hook ç±»å‹æ¨å¯¼
export function useTypedQuery<T>() {
  return useQuery<ApiResponse<T>>({
    // ...
  });
}
```

---

## ğŸ‰ å®æˆ˜ç¤ºä¾‹

å®Œæ•´çš„å¢åˆ æ”¹æŸ¥ç¤ºä¾‹ï¼š

```typescript
// stores/todosStore.ts
export const useTodosStore = create<TodosState>()((set) => ({
  filter: 'all',
  setFilter: (filter) => set({ filter }),
}));

// hooks/useTodosApi.ts
export function useTodos() {
  const filter = useTodosStore(state => state.filter);
  return useQuery({
    queryKey: ['todos', filter],
    queryFn: () => fetchTodos(filter),
  });
}

export function useAddTodo() {
  return useMutation({
    mutationFn: addTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

export function useUpdateTodo() {
  return useMutation({
    mutationFn: updateTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

export function useDeleteTodo() {
  return useMutation({
    mutationFn: deleteTodo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// Component
function TodoApp() {
  const { filter, setFilter } = useTodosStore();
  const { data: todos, isLoading } = useTodos();
  const { mutate: addTodo } = useAddTodo();
  const { mutate: updateTodo } = useUpdateTodo();
  const { mutate: deleteTodo } = useDeleteTodo();
  
  if (isLoading) return <div>Loading...</div>;
  
  return (
    <div>
      <select value={filter} onChange={e => setFilter(e.target.value)}>
        <option value="all">å…¨éƒ¨</option>
        <option value="active">è¿›è¡Œä¸­</option>
        <option value="completed">å·²å®Œæˆ</option>
      </select>
      
      {todos.map(todo => (
        <div key={todo.id}>
          <span>{todo.title}</span>
          <button onClick={() => updateTodo(todo)}>æ›´æ–°</button>
          <button onClick={() => deleteTodo(todo.id)}>åˆ é™¤</button>
        </div>
      ))}
      
      <button onClick={() => addTodo({ title: 'New Todo' })}>
        æ·»åŠ 
      </button>
    </div>
  );
}
```

---

éœ€è¦æ›´å¤šå¸®åŠ©ï¼ŸæŸ¥çœ‹[å®Œæ•´ä½¿ç”¨æŒ‡å—](./çŠ¶æ€ç®¡ç†ä½¿ç”¨æŒ‡å—.md) ğŸ“š
